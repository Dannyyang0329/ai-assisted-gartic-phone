{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <title>ArtFlow - {{ room_name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/room.css' %}">
</head>
<body class="room-page">
    <!-- 背景裝飾 -->
    <div class="background-shape shape-1"></div>
    <div class="background-shape shape-2"></div>
    <div class="background-shape shape-3"></div>
    
    <!-- 導航欄 -->
    <nav class="navbar">
        <div class="logo">Art<span>Flow</span></div>
        <div class="room-info">{{ room_name }}</div>
        <div class="nav-actions">
            <button onclick="window.location.href='/'" class="btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>大廳</span>
            </button>
        </div>
    </nav>
    
    <div class="game-container">
        <!-- 側邊欄：玩家列表和聊天 -->
        <div class="sidebar">
            <div class="card player-card">
                <h3>玩家列表</h3>
                <div id="player-list">
                    <ul id="players"></ul>
                </div>
                <button id="start-game-button" class="btn btn-success">開始遊戲</button>
            </div>
            
            <div class="card chat-card">
                <h3>聊天室</h3>
                <div id="chat-log"></div>
                <div id="chat-controls">
                    <input id="chat-message-input" type="text" placeholder="輸入訊息..." class="form-input">
                    <button id="chat-message-submit" class="btn-chat">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="send-icon">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- 主遊戲區域 -->
        <div class="main-content">
            <div id="game-status" class="status-bar">
                <div class="status-icon"></div>
                <span>等待玩家加入...</span>
            </div>
            
            <!-- 寫題目區域 -->
            <div id="prompt-input-area" class="game-stage-area hidden">
                <div class="card game-card">
                    <div class="card-header">
                        <h3>請輸入一個有趣的題目</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <input id="prompt-input" type="text" placeholder="例如：一隻貓在彈吉他..." class="form-input" autofocus>
                        </div>
                        <button id="submit-prompt-button" class="btn btn-block">提交題目</button>
                    </div>
                </div>
            </div>

            <!-- 畫圖區域 -->
            <div id="drawing-area" class="game-stage-area hidden">
                <div class="card game-card">
                    <div class="card-header">
                        <h3>輪到你畫畫了！</h3>
                        <div id="prompt-to-draw">題目：<span></span></div>
                    </div>
                    <div class="card-body">
                        <div id="drawing-tools">
                            <button id="clear-button" class="tool-btn" title="清除畫布">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                            <div class="color-picker-container">
                                <input type="color" id="color-picker" value="#000000" title="選擇顏色">
                            </div>
                            <div class="line-width-control">
                                <input type="range" id="line-width" min="1" max="20" value="5" title="調整線寬">
                                <span id="line-width-value">5</span>
                            </div>
                        </div>
                        <div id="canvas-container">
                            <canvas id="drawing-canvas"></canvas>
                        </div>
                        <button id="submit-drawing-button" class="btn btn-block">完成繪畫</button>
                    </div>
                </div>
            </div>

            <!-- 猜題區域 -->
            <div id="guess-input-area" class="game-stage-area hidden">
                <div class="card game-card">
                    <div class="card-header">
                        <h3>輪到你猜猜看了！</h3>
                    </div>
                    <div class="card-body">
                        <div id="image-to-guess-container">
                            <p>這是什麼？</p>
                            <img id="image-to-guess" src="" alt="等待繪畫...">
                        </div>
                        <div class="form-group">
                            <input id="guess-input" type="text" placeholder="輸入你的猜測..." class="form-input">
                        </div>
                        <button id="submit-guess-button" class="btn btn-block">提交猜測</button>
                    </div>
                </div>
            </div>

            <!-- 結果顯示區域 -->
            <div id="results-area" class="game-stage-area hidden">
                <div class="card game-card results-card">
                    <div class="card-header">
                        <h2>遊戲結束！結果如下</h2>
                    </div>
                    <div class="card-body">
                        <div id="books-container"></div>
                        <button onclick="window.location.href='/'" class="btn btn-secondary">返回大廳</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roomName = "{{ room_name }}";
        const drawingCanvasEl = document.getElementById('drawing-canvas');
        const canvasContainer = document.getElementById('canvas-container');
        
        // 動態設定畫布尺寸以匹配容器
        function resizeCanvas() {
            const cs = getComputedStyle(canvasContainer);
            const width = parseInt(cs.getPropertyValue('width'), 10);
            const height = parseInt(cs.getPropertyValue('height'), 10);
            drawingCanvasEl.width = width;
            drawingCanvasEl.height = height;
            
            // 重新繪製背景色和恢復 context 設置
            if (context) {
                context.fillStyle = "#FFFFFF";
                context.fillRect(0, 0, drawingCanvasEl.width, drawingCanvasEl.height);
                context.lineCap = 'round';
                context.lineJoin = 'round';
                context.lineWidth = lineWidth.value;
                context.strokeStyle = colorPicker.value;
            }
        }

        const context = drawingCanvasEl.getContext('2d');
        const chatLog = document.getElementById('chat-log');
        const chatMessageInput = document.getElementById('chat-message-input');
        const chatMessageSubmit = document.getElementById('chat-message-submit');
        const clearButton = document.getElementById('clear-button');
        const colorPicker = document.getElementById('color-picker');
        const lineWidth = document.getElementById('line-width');
        const lineWidthValue = document.getElementById('line-width-value');
        
        // 獲取當前登入用戶信息
        const currentUser = {
            isAuthenticated: false,
            username: "guest_" + Math.random().toString(36).substring(2, 7),
            displayName: "訪客"
        };

        // UI 元素
        const gameStatus = document.getElementById('game-status');
        const playerList = document.getElementById('players');
        const startGameButton = document.getElementById('start-game-button');
        const promptInputArea = document.getElementById('prompt-input-area');
        const promptInput = document.getElementById('prompt-input');
        const submitPromptButton = document.getElementById('submit-prompt-button');
        const drawingArea = document.getElementById('drawing-area');
        const promptToDraw = document.getElementById('prompt-to-draw').querySelector('span');
        const submitDrawingButton = document.getElementById('submit-drawing-button');
        const guessInputArea = document.getElementById('guess-input-area');
        const imageToGuess = document.getElementById('image-to-guess');
        const guessInput = document.getElementById('guess-input');
        const submitGuessButton = document.getElementById('submit-guess-button');
        const resultsArea = document.getElementById('results-area');
        const booksContainer = document.getElementById('books-container');

        // 遊戲狀態變數
        let currentGameState = 'waiting';
        let myPlayerId = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // 初始化畫布
        context.lineCap = 'round';
        context.lineJoin = 'round';
        context.lineWidth = 5;

        // --- WebSocket 連接 ---
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const gameSocket = new WebSocket(
            `${wsProtocol}//${window.location.host}/ws/game/${roomName}/`
        );

        gameSocket.onopen = function(e) {
            console.log('WebSocket connection established');
            resizeCanvas();
            sendMessage('user_info', {
                username: currentUser.username,
                displayName: currentUser.displayName
            });
        };
        
        gameSocket.onclose = function(e) {
            console.error('WebSocket connection closed unexpectedly');
            showStatusMessage('連線已中斷，請重新整理頁面。', 'error');
        };

        gameSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
            showStatusMessage('連線錯誤，請檢查網路或伺服器狀態。', 'error');
        }

        // --- 處理來自伺服器的訊息 ---
        gameSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageType = data.type;
            const payload = data.payload;
            console.log("Received message:", messageType, payload);

            switch (messageType) {
                case 'chat':
                    appendChatMessage(payload.sender, payload.text);
                    break;
                case 'game_state_update':
                    updateUI(payload);
                    break;
                case 'request_prompt':
                    showPromptInput();
                    break;
                case 'request_drawing':
                    showDrawingArea(payload.prompt_or_guess);
                    break;
                case 'request_guess':
                    showGuessInput(payload.drawing_data);
                    break;
                case 'game_over':
                    showResults(payload);
                    break;
                case 'clear_canvas_instruction':
                    clearLocalCanvas();
                    break;
                case 'error':
                    showStatusMessage(`錯誤: ${payload.message}`, 'error');
                    break;
                default:
                    console.warn("Unhandled message type:", messageType);
            }
        };

        // --- UI 更新函數 ---
        function updateUI(stateData) {
            currentGameState = stateData.state;
            showStatusMessage(getGameStateText(currentGameState) + (stateData.status_message ? ` - ${stateData.status_message}` : ''), currentGameState);
            updatePlayerList(stateData.players, stateData.waiting_on);

            hideAllSections();

            const isActivePlayer = !stateData.waiting_on || !stateData.waiting_on.includes(myPlayerId);

            startGameButton.style.display = (currentGameState === 'waiting' && Object.keys(stateData.players).length >= 1) ? 'block' : 'none';
            startGameButton.disabled = !(currentGameState === 'waiting' && Object.keys(stateData.players).length >= 2);

            if (currentGameState === 'finished') {
                resultsArea.classList.remove('hidden');
            }
        }

        function showStatusMessage(message, state = 'info') {
            const statusEl = gameStatus.querySelector('span');
            statusEl.textContent = message;
            
            // 更新狀態圖標
            const statusIcon = gameStatus.querySelector('.status-icon');
            statusIcon.className = 'status-icon';
            statusIcon.classList.add(`status-${state}`);
            
            // 添加動畫
            gameStatus.classList.remove('pulse-animation');
            void gameStatus.offsetWidth; // 觸發重繪
            gameStatus.classList.add('pulse-animation');
        }

        function getGameStateText(state) {
            switch(state) {
                case 'waiting': return '等待玩家加入';
                case 'prompting': return '正在輸入題目';
                case 'drawing': return '正在繪畫';
                case 'guessing': return '正在猜測';
                case 'finished': return '遊戲結束';
                default: return state;
            }
        }

        function updatePlayerList(players, waitingOn = []) {
            playerList.innerHTML = '';
            for (const playerId in players) {
                const player = players[playerId];
                const li = document.createElement('li');
                li.className = 'player-item';
                
                // 創建玩家狀態指示燈
                const statusDot = document.createElement('span');
                statusDot.className = 'player-status-dot';
                
                // 添加適當的類別
                if (waitingOn && waitingOn.includes(playerId)) {
                    statusDot.classList.add('waiting');
                } else if (currentGameState !== 'waiting' && currentGameState !== 'finished') {
                    statusDot.classList.add('ready');
                }
                
                li.appendChild(statusDot);
                
                // 添加玩家名稱
                const nameSpan = document.createElement('span');
                nameSpan.className = 'player-name';
                nameSpan.textContent = player.name || `玩家 ${playerId.substring(0, 4)}`;
                li.appendChild(nameSpan);
                
                // 如果需要，添加玩家狀態文字
                if (currentGameState !== 'waiting' && currentGameState !== 'finished') {
                    const statusText = document.createElement('span');
                    statusText.className = 'player-status';
                    
                    if (waitingOn && waitingOn.includes(playerId)) {
                        if (currentGameState === 'prompting') {
                            statusText.textContent = '輸入中';
                        } else if (currentGameState === 'drawing') {
                            statusText.textContent = '繪圖中';
                        } else if (currentGameState === 'guessing') {
                            statusText.textContent = '猜測中';
                        }
                    } else {
                        statusText.textContent = '已完成';
                        statusText.classList.add('completed');
                    }
                    
                    li.appendChild(statusText);
                }
                
                playerList.appendChild(li);
            }
        }

        function hideAllSections() {
            document.querySelectorAll('.game-stage-area').forEach(el => {
                el.classList.add('hidden');
            });
        }

        function showPromptInput() {
            hideAllSections();
            promptInputArea.classList.remove('hidden');
            promptInput.focus();
            submitPromptButton.disabled = false;
            
            // 添加動畫效果
            promptInputArea.classList.add('fade-in-animation');
        }

        function showDrawingArea(promptText) {
            hideAllSections();
            drawingArea.classList.remove('hidden');
            drawingArea.classList.add('fade-in-animation');
            
            resizeCanvas();
            promptToDraw.textContent = promptText;
            clearLocalCanvas(); 
            submitDrawingButton.disabled = false;
            drawingCanvasEl.focus();
        }

        function showGuessInput(drawingDataUrl) {
            hideAllSections();
            guessInputArea.classList.remove('hidden');
            guessInputArea.classList.add('fade-in-animation');
            
            imageToGuess.src = drawingDataUrl;
            imageToGuess.onload = () => {
                guessInput.value = '';
                guessInput.focus();
            };
            imageToGuess.onerror = () => {
                imageToGuess.alt = "圖片載入失敗";
                guessInput.value = '';
                guessInput.focus();
            };
            submitGuessButton.disabled = false;
        }

        function showResults(payload) {
            hideAllSections();
            resultsArea.classList.remove('hidden');
            resultsArea.classList.add('fade-in-animation');
            
            booksContainer.innerHTML = '';
            
            const players = payload.players;
            const turnOrder = Array.isArray(payload.turn_order) && payload.turn_order.length > 0
                               ? payload.turn_order
                               : Object.keys(payload.books || {});

            if (turnOrder.length === 0) {
                booksContainer.textContent = '沒有找到結果。';
                return;
            }

            turnOrder.forEach(originalPlayerId => {
                const book = payload.books[originalPlayerId];
                if (!book || book.length === 0) return;

                const bookDiv = document.createElement('div');
                bookDiv.className = 'book';

                const originalPlayerName = players[originalPlayerId]?.name || `玩家 ${originalPlayerId.substring(0,4)}`;
                const title = document.createElement('h4');
                title.textContent = `${originalPlayerName} 的故事本`;
                bookDiv.appendChild(title);

                book.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'book-item';
                    const itemPlayerName = players[item.player]?.name || `玩家 ${item.player.substring(0,4)}`;

                    const typeTag = document.createElement('div');
                    typeTag.className = 'book-item-tag';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'book-item-content';

                    if (item.type === 'prompt') {
                        typeTag.textContent = '題目';
                        typeTag.classList.add('tag-prompt');
                        
                        const contentText = document.createElement('p');
                        contentText.innerHTML = `<strong>${itemPlayerName}</strong>: ${item.data}`;
                        contentDiv.appendChild(contentText);
                    } else if (item.type === 'drawing') {
                        typeTag.textContent = '繪畫';
                        typeTag.classList.add('tag-drawing');
                        
                        const contentText = document.createElement('p');
                        contentText.innerHTML = `<strong>${itemPlayerName}</strong>`;
                        contentDiv.appendChild(contentText);
                        
                        const img = document.createElement('img');
                        img.src = item.data;
                        img.alt = `${itemPlayerName} 的繪畫`;
                        img.className = 'book-drawing';
                        contentDiv.appendChild(img);
                    } else if (item.type === 'guess') {
                        typeTag.textContent = '猜測';
                        typeTag.classList.add('tag-guess');
                        
                        const contentText = document.createElement('p');
                        contentText.innerHTML = `<strong>${itemPlayerName}</strong>: ${item.data}`;
                        contentDiv.appendChild(contentText);
                    }
                    
                    itemDiv.appendChild(typeTag);
                    itemDiv.appendChild(contentDiv);
                    bookDiv.appendChild(itemDiv);
                });
                booksContainer.appendChild(bookDiv);
            });
        }

        // --- 發送訊息到伺服器 ---
        function sendMessage(type, payload = {}) {
            if (gameSocket.readyState === WebSocket.OPEN) {
                gameSocket.send(JSON.stringify({ type, payload }));
                console.log("Sent message:", type, payload);
            } else {
                console.error("WebSocket is not open. Cannot send message.");
                showStatusMessage("無法連接伺服器，請重新整理頁面。", "error");
            }
        }

        // --- 事件監聽器 ---
        startGameButton.onclick = function() {
            sendMessage('start_game');
            startGameButton.disabled = true; 
            startGameButton.textContent = '正在啟動...';
        };

        submitPromptButton.onclick = function() {
            const promptText = promptInput.value.trim();
            if (promptText) {
                sendMessage('submit_prompt', { prompt: promptText });
                promptInput.value = '';
                submitPromptButton.disabled = true;
                showStatusMessage('題目已提交，等待其他玩家...', 'info');
            } else {
                showStatusMessage('請輸入題目！', 'error');
            }
        };
        
        promptInput.onkeyup = function(e) {
            if (e.key === 'Enter') {
                submitPromptButton.click();
            }
        };

        submitDrawingButton.onclick = function() {
            const drawingDataUrl = drawingCanvasEl.toDataURL();
            sendMessage('submit_drawing', { drawing: drawingDataUrl });
            submitDrawingButton.disabled = true;
            showStatusMessage('繪畫已提交，等待其他玩家...', 'info');
        };

        submitGuessButton.onclick = function() {
            const guessText = guessInput.value.trim();
            if (guessText) {
                sendMessage('submit_guess', { guess: guessText });
                guessInput.value = '';
                submitGuessButton.disabled = true;
                showStatusMessage('猜測已提交，等待其他玩家...', 'info');
            } else {
                showStatusMessage('請輸入你的猜測！', 'error');
            }
        };
        
        guessInput.onkeyup = function(e) {
            if (e.key === 'Enter') {
                submitGuessButton.click();
            }
        };

        chatMessageSubmit.onclick = function(e) {
            const message = chatMessageInput.value.trim();
            if (message) {
                sendMessage('chat_message', { message: message });
                chatMessageInput.value = '';
            }
        };
        
        chatMessageInput.onkeyup = function(e) {
            if (e.key === 'Enter') {
                chatMessageSubmit.click();
            }
        };

        function appendChatMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message animate__animated animate__fadeIn';
            
            const senderElement = document.createElement('div');
            senderElement.className = 'chat-sender';
            senderElement.textContent = sender;
            
            const textElement = document.createElement('div');
            textElement.className = 'chat-text';
            textElement.textContent = text;
            
            messageElement.appendChild(senderElement);
            messageElement.appendChild(textElement);
            
            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // --- 畫布相關 ---
        lineWidth.addEventListener('input', function() {
            lineWidthValue.textContent = this.value;
            context.lineWidth = this.value;
        });

        colorPicker.addEventListener('input', function() {
            context.strokeStyle = this.value;
        });

        clearButton.addEventListener('click', function() {
            clearLocalCanvas();
            sendMessage('clear_canvas');
        });

        function clearLocalCanvas() {
            const currentStrokeStyle = context.strokeStyle;
            const currentLineWidth = context.lineWidth;
            const currentLineCap = context.lineCap;
            const currentLineJoin = context.lineJoin;

            context.clearRect(0, 0, drawingCanvasEl.width, drawingCanvasEl.height);
            context.fillStyle = "#FFFFFF";
            context.fillRect(0, 0, drawingCanvasEl.width, drawingCanvasEl.height);

            context.strokeStyle = currentStrokeStyle;
            context.lineWidth = currentLineWidth;
            context.lineCap = currentLineCap;
            context.lineJoin = currentLineJoin;
        }

        // 繪圖事件
        drawingCanvasEl.addEventListener('mousedown', function(e) {
            if (currentGameState !== 'drawing' || submitDrawingButton.disabled) return;
            isDrawing = true;
            const rect = drawingCanvasEl.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        });

        drawingCanvasEl.addEventListener('mousemove', function(e) {
            if (!isDrawing || currentGameState !== 'drawing' || submitDrawingButton.disabled) return;

            const rect = drawingCanvasEl.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            context.beginPath();
            context.moveTo(lastX, lastY);
            context.lineTo(currentX, currentY);
            context.stroke();

            [lastX, lastY] = [currentX, currentY];
        });

        // 觸控支援
        drawingCanvasEl.addEventListener('touchstart', function(e) {
            if (currentGameState !== 'drawing' || submitDrawingButton.disabled) return;
            e.preventDefault();
            isDrawing = true;
            const touch = e.touches[0];
            const rect = drawingCanvasEl.getBoundingClientRect();
            lastX = touch.clientX - rect.left;
            lastY = touch.clientY - rect.top;
        });

        drawingCanvasEl.addEventListener('touchmove', function(e) {
            if (!isDrawing || currentGameState !== 'drawing' || submitDrawingButton.disabled) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const rect = drawingCanvasEl.getBoundingClientRect();
            const currentX = touch.clientX - rect.left;
            const currentY = touch.clientY - rect.top;
            
            context.beginPath();
            context.moveTo(lastX, lastY);
            context.lineTo(currentX, currentY);
            context.stroke();

            [lastX, lastY] = [currentX, currentY];
        });

        ['mouseup', 'mouseout', 'touchend', 'touchcancel'].forEach(event => {
            drawingCanvasEl.addEventListener(event, () => {
                isDrawing = false;
            });
        });
        
        window.addEventListener('resize', resizeCanvas);

        // 初始隱藏所有遊戲階段區域
        hideAllSections();
        showStatusMessage('正在連接伺服器...', 'connecting');
    </script>
</body>
</html>
