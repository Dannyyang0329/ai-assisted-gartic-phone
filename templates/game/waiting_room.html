{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <title>ArtFlow - {{ room_name }} 等待室</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/room.css' %}">
    <link rel="stylesheet" href="{% static 'css/waiting_room.css' %}">
</head>
<body class="room-page waiting-room-page">
    <!-- 背景裝飾 -->
    <div class="background-shape shape-1"></div>
    <div class="background-shape shape-2"></div>
    <div class="background-shape shape-3"></div>
    
    <!-- 導航欄 -->
    <nav class="navbar">
        <div class="logo">Art<span>Flow</span></div>
        <div class="room-info">{{ room_name }}</div>
        <div class="nav-actions">
            <button onclick="window.location.href='/'" class="btn-secondary">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="nav-icon">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>大廳</span>
            </button>
        </div>
    </nav>
    
    <div class="container waiting-container">
        <div class="room-header">
            <div class="header-content">
                <div class="header-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v4"></path>
                        <path d="M12 16h.01"></path>
                    </svg>
                </div>
                <div class="header-text">
                    <h1>等待其他玩家加入</h1>
                    <p class="room-description">分享以下連結給好友一起同樂，或添加機器人玩家！</p>
                </div>
            </div>
            <div class="action-container">
                <button id="help-button" class="help-button" title="查看遊戲說明">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12" y2="17"></line>
                    </svg>
                    <span>遊戲說明</span>
                </button>
                <div class="share-link">
                    <input type="text" id="room-link" readonly value="{{ request.build_absolute_uri|urlencode }}" class="form-input">
                    <button id="copy-link" class="btn-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="waiting-content">
            <!-- 左側：玩家列表和操作 -->
            <div class="player-section">
                <div class="card player-card">
                    <h3>玩家列表</h3>
                    <div class="player-count">
                        <span id="player-count-display">1</span>/8 位玩家
                    </div>

                    <div class="player-list-container">
                        <ul id="player-list" class="player-list">
                            <!-- JavaScript 會填充玩家列表 -->
                        </ul>
                    </div>
                    
                    <div class="waiting-actions">
                        <button id="add-bot" class="btn btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                                <path d="M12 2a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8z"></path>
                                <path d="M16 4h2a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                                <path d="M6 9h.01"></path>
                                <path d="M10 9h.01"></path>
                                <path d="M15 17v-1a4 4 0 0 0-4-4h-2a4 4 0 0 0-4 4v1a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1z"></path>
                                <path d="M8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                                <path d="M16 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"></path>
                            </svg>
                            添加機器人
                        </button>
                        <button id="remove-bot" class="btn btn-danger" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                            </svg>
                            移除機器人
                        </button>
                    </div>
                    
                    <button id="start-game-button" class="btn btn-start" disabled>
                        開始遊戲
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="btn-icon">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- 右側：聊天室 -->
            <div class="card chat-card">
                <h3>聊天室</h3>
                <div id="chat-log" class="chat-log"></div>
                <div id="chat-controls" class="chat-controls">
                    <input id="chat-message-input" type="text" placeholder="輸入訊息..." class="form-input">
                    <button id="chat-message-submit" class="btn-chat">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="send-icon">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 遊戲說明模態視窗 -->
    <div id="instructions-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>遊戲說明</h2>
                <button id="close-modal" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="game-instructions">
                    <div class="instruction-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>出題階段</h4>
                            <p>每位玩家提出一個有趣的題目或場景描述</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>繪畫階段</h4>
                            <p>玩家需根據分配到的題目進行創意繪畫</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>猜測階段</h4>
                            <p>猜測其他玩家繪畫的原始題目是什麼</p>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>結果展示</h4>
                            <p>查看所有玩家的題目、繪畫和猜測，一起歡笑！</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 彈出通知 -->
    <div id="notification" class="notification hidden">
        <svg class="notification-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <span id="notification-text">連結已複製!</span>
    </div>
    
    <script>
        const roomName = "{{ room_name }}";
        
        // 獲取當前登入用戶信息
        const currentUser = {
            isAuthenticated: false,
            username: "guest_" + Math.random().toString(36).substring(2, 7),
            displayName: "訪客"
        };

        // DOM 元素
        const playerList = document.getElementById('player-list');
        const playerCountDisplay = document.getElementById('player-count-display');
        const chatLog = document.getElementById('chat-log');
        const chatMessageInput = document.getElementById('chat-message-input');
        const chatMessageSubmit = document.getElementById('chat-message-submit');
        const startGameButton = document.getElementById('start-game-button');
        const addBotButton = document.getElementById('add-bot');
        const removeBotButton = document.getElementById('remove-bot');
        const copyLinkButton = document.getElementById('copy-link');
        const roomLinkInput = document.getElementById('room-link');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');

        // 設定不包含使用者ID的分享連結
        const cleanShareUrl = `${window.location.protocol}//${window.location.host}/waiting_room/${roomName}/`;
        roomLinkInput.value = cleanShareUrl;

        // 玩家資料
        let players = [];
        let botCount = 0;
        const MAX_PLAYERS = 8;
        const MIN_PLAYERS_TO_START = 2;
        
        // 從URL獲取用戶ID (如果有)
        const urlParams = new URLSearchParams(window.location.search);
        const userIdFromUrl = urlParams.get('userid');
        if (userIdFromUrl) {
            currentUser.username = userIdFromUrl;
        }
        
        // WebSocket 連接
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const gameSocket = new WebSocket(
            `${wsProtocol}//${window.location.host}/ws/waiting_room/${roomName}/?userid=${encodeURIComponent(currentUser.username)}`
        );

        gameSocket.onopen = function(e) {
            console.log('WebSocket connection established');
            sendMessage('user_info', {
                username: currentUser.username,
                displayName: currentUser.displayName
            });
        };
        
        gameSocket.onclose = function(e) {
            console.error('WebSocket connection closed unexpectedly');
            showNotification('連線已中斷，請重新整理頁面。', 'error');
        };

        gameSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
            showNotification('連線錯誤，請檢查網路或伺服器狀態。', 'error');
        }

        // 處理收到的訊息
        gameSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageType = data.type;
            const payload = data.payload;
            
            console.log("Received message:", messageType, payload);

            switch (messageType) {
                case 'room_update':
                    updateRoomState(payload);
                    break;
                case 'chat':
                    appendChatMessage(payload.sender, payload.text);
                    break;
                case 'notification':
                    showNotification(payload.message, payload.level || 'info');
                    break;
                case 'game_started':
                    // 遊戲開始，跳轉到遊戲頁面
                    window.location.href = `/room/${roomName}/`;
                    break;
                case 'error':
                    showNotification(`錯誤: ${payload.message}`, 'error');
                    break;
            }
        };

        // 發送訊息到伺服器
        function sendMessage(type, payload = {}) {
            if (gameSocket.readyState === WebSocket.OPEN) {
                gameSocket.send(JSON.stringify({ type, payload }));
            } else {
                showNotification("無法連接伺服器，請重新整理頁面。", "error");
            }
        }

        // 更新房間狀態
        function updateRoomState(roomState) {
            players = roomState.players || [];
            botCount = roomState.bot_count || 0;
            
            // 更新玩家列表
            updatePlayerList();
            
            // 更新玩家數量
            const playerCount = players.length;
            playerCountDisplay.textContent = playerCount;
            
            // 更新按鈕狀態
            startGameButton.disabled = playerCount < MIN_PLAYERS_TO_START;
            addBotButton.disabled = playerCount >= MAX_PLAYERS || botCount >= 3;
            removeBotButton.disabled = botCount <= 0;
            
            // 如果有足夠玩家，顯示可以開始的提示
            if (playerCount >= MIN_PLAYERS_TO_START && startGameButton.disabled) {
                showNotification("已有足夠玩家，可以開始遊戲！", "success");
                startGameButton.disabled = false;
            }
        }

        // 更新玩家列表
        function updatePlayerList() {
            playerList.innerHTML = '';
            
            players.forEach((player, index) => {
                const li = document.createElement('li');
                li.className = 'player-item';
                
                // 創建玩家狀態指示燈
                const statusDot = document.createElement('span');
                statusDot.className = 'player-status-dot';
                
                if (player.isBot) {
                    statusDot.classList.add('bot');
                } else {
                    statusDot.classList.add('ready');
                }
                
                li.appendChild(statusDot);
                
                // 添加玩家順序號碼
                const orderNumber = document.createElement('span');
                orderNumber.className = 'player-number';
                orderNumber.textContent = index + 1;
                li.appendChild(orderNumber);
                
                // 添加玩家名稱
                const nameSpan = document.createElement('span');
                nameSpan.className = 'player-name';
                nameSpan.textContent = player.name;
                
                if (player.isBot) {
                    nameSpan.innerHTML += ' <span class="bot-tag">機器人</span>';
                } else if (player.isHost) {
                    nameSpan.innerHTML += ' <span class="host-tag">房主</span>';
                } else if (player.id === currentUser.username) {
                    nameSpan.innerHTML += ' <span class="you-tag">(你)</span>';
                }
                
                li.appendChild(nameSpan);
                
                playerList.appendChild(li);
            });
        }

        // 添加聊天訊息
        function appendChatMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message animate__animated animate__fadeIn';
            
            const senderElement = document.createElement('div');
            senderElement.className = 'chat-sender';
            senderElement.textContent = sender;
            
            const textElement = document.createElement('div');
            textElement.className = 'chat-text';
            textElement.textContent = text;
            
            messageElement.appendChild(senderElement);
            messageElement.appendChild(textElement);
            
            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // 顯示通知
        function showNotification(message, type = 'info') {
            notificationText.textContent = message;
            notification.className = `notification notification-${type} animate__animated animate__fadeIn`;
            notification.classList.remove('hidden');
            
            // 3秒後隱藏
            setTimeout(() => {
                notification.classList.add('animate__fadeOut');
                setTimeout(() => {
                    notification.classList.add('hidden');
                    notification.classList.remove('animate__fadeOut');
                }, 500);
            }, 3000);
        }

        // 添加機器人
        addBotButton.addEventListener('click', function() {
            sendMessage('add_bot');
        });

        // 移除機器人
        removeBotButton.addEventListener('click', function() {
            sendMessage('remove_bot');
        });

        // 開始遊戲
        startGameButton.addEventListener('click', function() {
            if (players.length >= MIN_PLAYERS_TO_START) {
                sendMessage('start_game');
                startGameButton.disabled = true;
                startGameButton.innerHTML = '正在準備遊戲...';
                showNotification('遊戲即將開始！', 'success');
            } else {
                showNotification(`至少需要 ${MIN_PLAYERS_TO_START} 位玩家才能開始遊戲`, 'error');
            }
        });

        // 複製連結
        copyLinkButton.addEventListener('click', function() {
            roomLinkInput.select();
            document.execCommand('copy');
            showNotification('房間連結已複製到剪貼簿！', 'success');
        });

        // 聊天功能
        chatMessageSubmit.addEventListener('click', function() {
            const message = chatMessageInput.value.trim();
            if (message) {
                sendMessage('chat_message', { message: message });
                chatMessageInput.value = '';
            }
        });

        chatMessageInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                chatMessageSubmit.click();
            }
        });
        
        // 模擬初始玩家狀態（第一個玩家就是當前用戶）
        const initialPlayers = [
            {
                id: currentUser.username,
                name: currentUser.displayName,
                isHost: true,
                isBot: false
            }
        ];
        
        players = initialPlayers;
        updatePlayerList();

        // 遊戲說明模態框控制
        const instructionsModal = document.getElementById('instructions-modal');
        const helpButton = document.getElementById('help-button');
        const closeModal = document.getElementById('close-modal');
        
        helpButton.addEventListener('click', function() {
            instructionsModal.classList.add('show');
        });
        
        closeModal.addEventListener('click', function() {
            instructionsModal.classList.remove('show');
        });
        
        // 點擊模態框外部關閉
        window.addEventListener('click', function(event) {
            if (event.target == instructionsModal) {
                instructionsModal.classList.remove('show');
            }
        });
    </script>
</body>
</html>
